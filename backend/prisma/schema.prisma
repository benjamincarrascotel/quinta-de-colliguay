// ============================================
// PRISMA SCHEMA - Quinta de Colliguay
// Genera tipos TypeScript autom치ticamente
// ============================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum Block {
  morning
  night
}

enum ReservationStatus {
  requested
  confirmed
  cancelled
}

enum NotificationType {
  client_request_created
  admin_request_created
  client_confirmed
  admin_confirmed
  client_cancelled
  admin_cancelled
}

enum NotificationStatus {
  pending
  sent
  failed
}

enum UserRole {
  admin
  super_admin
}

// ============================================
// MODELS
// ============================================

model Client {
  id           Int           @id @default(autoincrement())
  name         String
  whatsapp     String        @db.VarChar(15)
  email        String
  city         String
  reservations Reservation[]
  createdAt    DateTime      @default(now()) @map("created_at")
  updatedAt    DateTime      @updatedAt @map("updated_at")

  @@index([email])
  @@index([whatsapp])
  @@index([email, whatsapp])
  @@map("clients")
}

model Reservation {
  id                  Int            @id @default(autoincrement())
  clientId            Int            @map("client_id")
  client              Client         @relation(fields: [clientId], references: [id], onDelete: Cascade)

  // Fechas y bloques
  arrivalDate         DateTime       @map("arrival_date") @db.Date
  arrivalBlock        Block          @map("arrival_block")
  departureDate       DateTime       @map("departure_date") @db.Date
  departureBlock      Block          @map("departure_block")

  // Composici칩n del grupo
  adults              Int            @db.SmallInt
  children            Int            @default(0) @db.SmallInt

  // Estado y montos
  status              ReservationStatus @default(requested)
  estimatedAmount     Int            @map("estimated_amount")
  finalAmount         Int?           @map("final_amount")

  // Informaci칩n de anticipo
  depositAmount       Int?           @map("deposit_amount")
  depositDate         DateTime?      @map("deposit_date") @db.Date
  depositMethod       String?        @map("deposit_method")
  depositReference    String?        @map("deposit_reference")

  // Observaciones
  clientObservations  String?        @map("client_observations") @db.Text
  adminObservations   String?        @map("admin_observations") @db.Text

  // Cancelaci칩n
  cancellationReason  String?        @map("cancellation_reason") @db.Text
  cancelledAt         DateTime?      @map("cancelled_at")

  // Relaciones
  notifications       Notification[]
  auditLogs           AuditLog[]

  createdAt           DateTime       @default(now()) @map("created_at")
  updatedAt           DateTime       @updatedAt @map("updated_at")

  @@index([status, arrivalDate])
  @@index([arrivalDate, departureDate])
  @@index([createdAt])
  @@map("reservations")
}

model SystemParameter {
  id          Int      @id @default(autoincrement())
  key         String   @unique
  value       String   @db.Text
  type        String   @default("string")
  description String?  @db.Text
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("system_parameters")
}

model AuditLog {
  id             Int       @id @default(autoincrement())
  auditableType  String    @map("auditable_type")
  auditableId    Int       @map("auditable_id")
  action         String
  userId         Int?      @map("user_id")
  user           User?     @relation(fields: [userId], references: [id], onDelete: SetNull)
  reservation    Reservation? @relation(fields: [auditableId], references: [id], onDelete: Cascade)
  oldValues      Json?     @map("old_values")
  newValues      Json?     @map("new_values")
  ipAddress      String?   @map("ip_address") @db.VarChar(45)
  userAgent      String?   @map("user_agent") @db.Text
  createdAt      DateTime  @default(now()) @map("created_at")

  @@index([auditableType, auditableId])
  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

model Notification {
  id             Int                @id @default(autoincrement())
  reservationId  Int                @map("reservation_id")
  reservation    Reservation        @relation(fields: [reservationId], references: [id], onDelete: Cascade)
  type           NotificationType
  recipientEmail String             @map("recipient_email")
  recipientName  String?            @map("recipient_name")
  subject        String
  body           String             @db.Text
  attachments    Json?
  status         NotificationStatus @default(pending)
  sentAt         DateTime?          @map("sent_at")
  errorMessage   String?            @map("error_message") @db.Text
  attempts       Int                @default(0) @db.SmallInt
  createdAt      DateTime           @default(now()) @map("created_at")
  updatedAt      DateTime           @updatedAt @map("updated_at")

  @@index([status, createdAt])
  @@index([reservationId])
  @@map("notifications")
}

model User {
  id                Int        @id @default(autoincrement())
  name              String
  email             String     @unique
  emailVerifiedAt   DateTime?  @map("email_verified_at")
  password          String
  role              UserRole   @default(admin)
  isActive          Boolean    @default(true) @map("is_active")
  auditLogs         AuditLog[]
  createdAt         DateTime   @default(now()) @map("created_at")
  updatedAt         DateTime   @updatedAt @map("updated_at")

  @@map("users")
}
